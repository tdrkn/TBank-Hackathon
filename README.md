
# Финансовый новостной бот

## Что это
Этот репозиторий содержит исходный код Telegram‑бота, который агрегирует и
анализирует финансовые новости для розничных инвесторов. Бот собирает данные из
публичных RSS‑лент, пропускает тексты через модели OpenAI и Gemini, сохраняет
результат в PostgreSQL и показывает пользователям дайджест важных событий.

## Запуск локально
1. Скопируйте файл окружения и укажите свои ключи:
   ```bash
   cp .env.example .env
   # заполните токены в .env
   ```
2. Установите зависимости и подготовьте виртуальное окружение:
   ```bash
   make dev
   ```
3. Запустите бота:
   ```bash
   make run
   ```
При первом старте будет создана схема базы данных, после чего в консоли
появится сообщение `Bot started`.

## Docker
Полностью развернуть стек можно через `docker compose`:
```bash
docker compose up --build
```
Будут запущены два контейнера: приложение и PostgreSQL. Код монтируется в
контейнер приложения, поэтому после изменений перезапускать его не требуется.

## Переменные окружения
- `TELEGRAM_TOKEN` – токен вашего бота.
- `OPENAI_API_KEY` – ключ OpenAI для извлечения структуры новости.
- `GEMINI_API_KEY` – ключ Gemini для генерации краткого описания.
- `TINVEST_TOKEN` – токен Tinkoff Invest API.
- `TINVEST_ENV` – окружение `prod` или `sandbox` для Tinkoff Invest.
- `RSS_FEEDS` – список RSS‑лент в формате `name=url,name=url`.
- `POSTGRES_*` – параметры подключения к базе данных.

По умолчанию бот использует следующие источники:
```
RSS_FEEDS="rbc=https://static.feed.rbc.ru/rbc/internal/rss.rbc.ru/rbc.ru/mainnews.rss,kommersant=https://www.kommersant.ru/RSS/section-economics.xml,cbr=http://www.cbr.ru/rss/RssNews,bankiru=https://www.banki.ru/news/lenta/?r1=rss&r2=news,finam_companies=https://www.finam.ru/analysis/conews/rsspoint/,finam_bonds=https://bonds.finam.ru/news/today/rss.asp,tass=https://tass.com/rss/v2.xml,profinance_stock=https://www.profinance.ru/fond.xml,profinance_economy=https://www.profinance.ru/econom.xml"
```

Полный список смотрите в `.env.example`.

## Команды бота
- `/start` – регистрация пользователя.
- `/subscribe <TICKER>` – подписка на новости выбранного тикера.
- `/unsubscribe <TICKER>` – отмена подписки.
- `/digest` – пять главных новостей дня с кратким описанием и смайликом
  тональности.
 - `/rank` – три самых интересных актива по итогам скоринга с объяснением,
  почему они могут быть привлекательны новичку.
  - `/help` – краткая справка по возможностям бота.

## Аналитика портфеля
Модуль `src/portfolio/analytics.py` показывает стоимость портфеля через API
Tinkoff Invest. Пример запуска:

```bash
python -m src.portfolio.analytics <ACCOUNT_ID> --sandbox
```

Скрипт вернёт сумму позиций и свободных средств в разрезе валют.

## Как это работает
1. **Парсер новостей.** Планировщик APScheduler каждые 30 минут
   запускает сборщик RSS‑лент. Для каждой новой ссылки вычисляется SHA‑256 и
   проверяется, не была ли она загружена ранее.
2. **Обработка LLM.** Текст новости отправляется в OpenAI, где функция
   `news_digest` извлекает тикер, краткое содержание, тональность и другие
   поля строго по заданной JSON‑схеме. При ошибке делается повторная попытка.
   Для генерации короткого описания используется Gemini.
3. **Хранение данных.** Сведения сохраняются в таблицу `articles`, а также
   используются для расчёта метрик интереса к активам. Результаты скоринга
   помещаются в таблицу `scores`.
4. **Бот.** Пользователь взаимодействует с Telegram‑ботом через команды,
   получает дайджест новостей и список самых интересных активов. Все данные
   выбираются из базы, обработка выполняется асинхронно.
5. **CI.** Репозиторий содержит GitHub Actions, которые при каждом push
   запускают проверку стиля (`ruff`), статический анализ (`mypy`), тесты и
   сборку Docker‑образа.

## Планы развития
В дальнейшем планируется подключить модель LightGBM для более точного расчёта
интереса к ценным бумагам и улучшить алгоритм ранжирования новостей.
